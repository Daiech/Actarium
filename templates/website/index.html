{% extends "website/layout.html" %}
{% block TITLE %}Home{% endblock %}

{%block body%}


{% if user.is_authenticated %}
<article id="b-page">
    <div class="modal hide fade" id="myReunionModal"> <!-- Ventana Modal para visualizar informacion de reuniones -->
        <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Detalles de la Reuni&oacute;n</h3>
        </div>
        <div class="modal-body">
            <div id="reunion-data">
                <div id="loading-reunion"></div>
            </div>
        </div>
    </div>
    <div id="content-container" class="row-fluid">
        <section id="notifications" class="span6">
            <div style="margin-left:60px;" class="white-box-container">
                <header class="row-fluid fix_btn">
                    <h4 class="span7 ml50">Actividad Reciente</h4>
                </header>
                <hr>
                <div class="accordion " id="accordion">
                    <div class="accordion-group">
                        <div class="accordion-heading">
                            <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#Invitations">
                                Tienes <span id="inv-count" class="badge badge-info">{{invitations|length}}</span> invitaciones a grupos
                            </a>
                        </div>
                        <div  id="Invitations" class="accordion-body collapse in">
                            <ul class="accordion-inner">
                                {% for invitation in invitations %}
                                <li>
                                    <span class="notification-text alpha60">
                                        <strong>{{invitation.id_user_from.first_name|lower|capfirst}}</strong> te invit&oacute; al grupo <a href="/groups/{{invitation.id_group.slug}}">{{invitation.id_group.name|lower|capfirst}}</a>
                                        <br />
                                        <time datetime="{{reunion.date_convened|date:'c'}}">El {{invitation.date_invited}}</time>
                                    </span>
                                    <div class="buttons">
                                        <button type="button" data-invitation="s{{invitation.id}}" class="accept-inv btn btn-small btn-info">
                                            Aceptar 
                                            <span class="load"></span>
                                        </button>
                                        <button type="button" data-invitation="n{{invitation.id}}" class="accept-inv btn btn-small">
                                            Cancelar
                                            <span class="load"></span>
                                        </button>
                                        <div class="pull-right load"></div>
                                    </div>
                                    <hr>

                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <div class="accordion-group">
                        <div class="accordion-heading">
                            <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#Reunions">
                                Tienes <span id="length-reunion" class="badge badge-info">{{reunions|length}}</span> reuniones pendientes
                            </a>
                        </div>
                        <div  id="Reunions" class="accordion-body collapse in">
                            <ul class="accordion-inner">

                                {% for reunion in reunions %}

                                <li data-group-name="{{reunion.group_name}}" data-date="{{reunion.date}}">
                                    <span class="notification-text">
                                        <strong>{{reunion.title}}</strong> (<a href="/groups/">{{reunion.group_name}}</a>)
                                        <time datetime="{{reunion.date}}">El {{reunion.date}}</time>
                                    </span>
                                    <div class="buttons">
                                        <a href="#" class="btn btn-small btn-info confirmed2-true" data-id_reunion="{{reunion.id_reunion}}">Asistir&eacute;</a>
                                        <a href="#" class="btn btn-small confirmed2-false" data-id_reunion="{{reunion.id_reunion}}">No Asistir&eacute;</a>
                                        <a class="btn btn-link get-reunion" href="#myReunionModal" data-toggle="modal" data-id-reunion="{{reunion.id_reunion}}">Ver m&aacute;s</a>
                                    </div>
                                    <hr>

                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div><!--cierra notifications-->

            </div>
        </section>
        <section class="white-box-container span5">
                <header class="row-fluid fix_btn">
                    <h4 class="span7">Tus grupos</h4>

                    <div class="span4">
                        <a href="/groups/new" class="btn btn-small">
                            <i class="icon-book"></i> Crear Grupo
                        </a>
                    </div>
                </header>
                <hr>
            
                <ul id="group-list" class="nav onOver">
                    {% for group in groups %}
                    <li class="">
                        <a href="/groups/{{group.slug}}">
                            <img src="{{ STATIC_PREFIX }}{{group.img_group}}" alt="{{group.name}}"/>
                            {{group.name}}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
        </section>
    </div>
</article>
{% else %}
<div id="new-container">
    <img id="logo-act-big" src="/static/img/logo_grande.png" alt="Logo Actarium"/>
    <p id="text-center"> la soluci&oacute;n empresarial para el registro de sus reuniones.</p>
</div>

<div id="middle-bar">
    <div id="middle-down">
        <div class="pic-down">
            <a href="#" title="info">
                <div id="arrow-down">

                </div>
            </a>
        </div>
    </div>
</div>
<div class="info-containter">
    <div class="info-pics">
        <div id="left-panel">
            <div id="register-form" class="hidden">
                <form name="" action="/account/login" method="POST" class="form-horizontal pull-right">
                    {% csrf_token %}
                    <label for="id_username-login">Nombre de usuario</label>
                    <input id="id_username-login" type="text" name="username" maxlength="30" placeholder="Nombre de usuario" autofocus class="first-input" />
                    <label for="id_password-login">Contrase&ntilde;a</label>
                    <input type="password" name="password" id="id_password-login" />

                    <div class="control-group">
                        <div class="controls">
                            <button type="submit" name="submit" id="id_submit" class="btn btn-success link-daiech">Inciar Sesi&oacute;n</button>
                            <a href="/account/password/reset/" class="btn btn-link">&iquest;Olvidaste tu contrase&ntilde;a?</a>
                        </div>
                    </div>
                </form>

            </div>
            <div id="pic-log-left" class="pic-log">
                <a href="/account/login" >
                    <div id="left-bubble">
                        <div class="bubble-text">
                            Tengo una cuenta.<br>Iniciar Sesi&oacute;n
                        </div>

                    </div>
                </a>
                <div id="login-pic">
                    <div id="img-log">

                    </div>
                </div>
            </div>
        </div>

        <div id="right-panel">
            <div id="new-user" class="hidden">
                <form name="" action="/account/new" method="POST" class="form-horizontal pull-right">
                    {% csrf_token %}
                    <label for="id_username-register">Nombre de usuario:</label>
                    <input id="id_username-register" type="text" name="username" maxlength="30" placeholder="Nombre de usuario" autofocus class="first-input" />
                    <label for="id_email">Correo Electr&oacute;nico:</label>
                    <input type="text" name="email" id="id_email"  placeholder="Correo Electr&oacute;nico" />
                    <label for="id_password1">Contraseña:</label>
                    <input type="password" name="password1" id="id_pasword1" />
                    <label for="id_password2">Contraseña(Confirmaci&oacute;n):</label>
                    <input type="password" name="password2" id="id_pasword2" />

                    <div class="control-group">
                        <div class="controls">
                            <button type="submit" name="submit" id="id_submit" class="btn btn-success link-daiech pull-right">Sign In</button>
                        </div>
                    </div>
                </form>

            </div>            

            <div id="pic-log-right" class="pic-log">
                <a href="/account/new">
                    <div id="right-bubble">
                        <div class="bubble-text">
                            No tengo cuenta.<br>Registrarme
                        </div>
                    </div>
                </a>
                <div id="singup-pic">
                    <div id="img-reg">

                    </div>
                </div>
            </div>
        </div>


    </div>
</div>


{% endif %}

{%endblock%}
{% block style%}
<style>

    /* **************************************************************************** 
    Index Website
    **************************************************************************** */
    #text-center{
        text-align: center;
    }
    
    .container{
        width:100%;
    }
    #middle-bar{
        height: 51px;
        position: absolute;
        width: 100%;
    }

    #middle-down{
        width:50px;
        margin: 0 auto;
    }
    #left-panel{
        display: block;
        float: left;
        width:45%;
    }
    #right-panel{
        display: block;
        float: right;
        width: 45%;
    }

    #new-container{
        background-color: #E9E9E9;
        height: 240px;
        min-height: 240px;
        width: 100%;
        padding-bottom: 35px;
    }
    #new-container > img{
        display: block;
        margin: auto;       
        padding-top: 30px;
        width:350px;
    }
    #register-form{
        width: 224px;
        float: right;
    }
    #register-form > form{
        padding: 25px;
        width: auto;
        border: none;
    }
    #new-user{
        width: auto;
        float: left;
    }
    #new-user > form{
        padding: 25px;
        width: auto;
        border: none;
    }
    #id_submit{
        width: auto;
    }
    .controls{
        margin-top: 15px;
    }
    #content-container .white-box-container{
        min-height: 220px;
    }

    /* **************************************************************************** 
    Termina Index Website
    **************************************************************************** */


    .accordion-heading{
        /*background-image: -webkit-linear-gradient(top, #62C462, #51A351);*/

        background-image: -webkit-linear-gradient(top, white, #E6E6E6);
        border-radius:5px;
    }

    .accordion-inner{
        /*background-color: gainsboro;*/
        /* Fallback for web browsers that doesn't support RGBa */
        background: rgb(255, 255, 255) transparent;
        /* RGBa with 0.6 opacity */
        background: rgba(255, 255, 255, 0.6);
        /* For IE 8*/
        -ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorstr=#11111111,endColorstr=#11111111)";
    }
    #b-page{
        padding-top: 100px;
    }
    .ml50{
        margin-left: 48px;
    }
    .accordion-group{
        border: solid #dadada thin;
        margin-top: 10px;
        width: 100%;
    }
    span.notification-text{
        display: block;
    }
    h4{
        margin:0;
        padding:0;
    }
    header h1{
        margin: 0;
    }
    .span2{
        margin-right: 20px;
    }
    #notifications ul *{
        list-style-type: none;
        font-size: 13px;
        margin-bottom: 5px;
    }/*
    li hr{
        margin:20;
    }*/
    ul{
        margin:0;
    }
    .containterMargin{
        margin:20px;
    }
    .buttons{
        margin-top:10px;
    }
</style>
{%endblock%}
{% block js %}
<script>
    $(document).on("ready",function(){
        $("#left-bubble").on("click", login);   // Ejecuta la funcion login on click
        $("#right-bubble").on("click", register);// Ejecuta la funcion register on click
    });
    
    function login(e){
        /*  Muestra el formulario para iniciar sesion
            Oculta el formulario de registro
        */
        e.preventDefault()
        if($("#pic-log-right").hasClass("hidden"))
        {
            $("#pic-log-right").removeClass("hidden")
            $("#pic-log-left").addClass("hidden")
            $("#register-form").removeClass("hidden")
            $("#new-user").addClass("hidden")
            $("#register-form form input.first-input").focus()
        }
        else{
            $("#pic-log-left").addClass("hidden")
            $("#register-form").removeClass("hidden")
        }
    }

    function register(e) {
        /*  Muestra el formulario para registro
            Oculta el formulario de login
        */
        e.preventDefault()
        if($("#pic-log-left").hasClass("hidden"))
        {
            $("#pic-log-right").addClass("hidden")
            $("#new-user").removeClass("hidden")
            $("#pic-log-left").removeClass("hidden")
            $("#register-form").addClass("hidden")
            $("#new-user form input.first-input").focus()
        }
        else{
            $("#pic-log-right").addClass("hidden")
            $("#new-user").removeClass("hidden")
        }
    }
</script>    
{% if user.is_authenticated%}
<script>
    $(".collapse").collapse({
        toggle: false
    })
    function acceptInvitation(element, accept){
        sendAjax(
        "/groups/acceptInvitation",
        {"i_id":accept},
        $(element).find(".load"),
        function(data){
            if (data["accepted"]){
                var actual = parseInt($("#inv-count").text());
                actual--;
                $("#inv-count").text(""+actual);
                $("#group-list").append(
                "<li class=''>"+
                    "<a href='"+data["group"]["slug"]+"'>"+
                    "<img src='{{STATIC_PREFIX}}"+data["group"]["img_group"]+"' alt=''/>"+
                    data["group"]["name"]+
                    "</a>"+
                    "</li>")
                $(element).parent().parent().slideUp(900,function(){
                    $(this).empty().html(
                    "Ahora perteneces al grupo "+
                        "<a href='"+data["group"]["slug"]+"'>"+data["group"]["name"]+"</a>"+
                        "<hr>"
                ).fadeIn()
                }
            )
                setAlertMessage("Invitaci&oacute;n a un nuevo grupo",
                "Ahora puedes acceder al grupo"+data["group"]["name"]+".")
            }
            else{
                $(element).parent().parent().slideUp(900,function(){
                    $(this).empty().html(
                    "Cancelaste la invitaci&oacute;n para unirte al grupo "+data["group"]["name"]+"."+
                        "<br>"+
                        "Si lo hiciste por error comunicate con el administrador del grupo para "+
                        "obtener una nueva invitaci&oacute;n."+
                        "<hr>"
                ).fadeIn()
                })
                var actual2 = parseInt($("#inv-count").text())
                actual2--
                $("#inv-count").text(""+actual2)
                setAlertMessage("Invitaci&oacute;n a un nuevo grupo",
                "Haz rechazado la invitaci&oacute;n")
            }
        })

        function confirm(id_reunion, is_confirmed, group_name, date){
            //console.log(id_reunion+" "+is_confirmed);
            sendAjax("/groups/setAssistance",
            {id_reunion:id_reunion, is_confirmed: is_confirmed},
            "#load_reunions",
            function(data){
                    
            }
        )
        }
        function setList(e,btn, op){
            var t = 500;
            e.preventDefault();
            li= btn.parent().parent();
            li.animate({'height': 0},t,function(){
                confirm(btn.attr("data-id_reunion"),op, $(this).attr("data-group-name"), $(this).attr("data-date"));
                $(this).remove();
                l = $("#length-reunion").html();
                $("#length-reunion").html(l-1);
            });
            //console.log(btn.attr("data-id_reunion"));
        }
        function setButtons(){
            $('.confirmed2-true').click(function(e){
                setList(e,$(this), true);
                //console.log($(this).attr("data-id_reunion"))
            });
            $('.confirmed2-false').click(function(e){
                setList(e,$(this),false);
                //console.log($(this).attr("data-id_reunion"))
            });	
        }
        setButtons();
    

    }
    $(".accept-inv").on("click",function(e){
        e.preventDefault();
        $(this).attr("disabled", "disabled");
        var accept = $(this).attr("data-invitation")
        if(accept.substring(0,1)=="n"){
            if(confirm("¿Seguro que no quieres ser parte de este grupo?")){
                acceptInvitation($(this), accept)
            }
            else{
                $(this).attr("disabled", false);
            }
        }else{
            acceptInvitation($(this), accept)
        }
    })
    function confirmar(id_reunion, is_confirmed, group_name, date){
        sendAjax("/groups/setAssistance",
        {id_reunion:id_reunion, is_confirmed: is_confirmed},
        "#load_reunions",
        function(data){
            console.log(data)
            setAlertMessage("Reuniones", "Puedes ver la actividad de tus reuniones en el men&uacute; <a href='/groups/calendar'>Reuniones</a>")
        }
    )
    }
    function setList(e,btn, op){
        var t = 500;
        e.preventDefault();
        li= btn.parent().parent();
        li.animate({'height': 0},t,function(){
            confirmar(btn.attr("data-id_reunion"),op, $(this).attr("data-group-name"), $(this).attr("data-date"));
            $(this).remove();
            l = $("#length-reunion").html();
            $("#length-reunion").html(l-1);
        });
    }
    function setButtons(){
        $('.confirmed2-true').click(function(e){
            $(this).attr("disabled", "disabled");
            setList(e,$(this), true);
        });
        $('.confirmed2-false').click(function(e){
            $(this).attr("disabled", "disabled");
            setList(e,$(this),false);
        });	
        $('.get-reunion').click(function(e){
            e.preventDefault();
            getReunionData($(this).attr("data-id-reunion"));
        });
    }
    function getReunionData(id_reunion){
        //console.log('dame una reunion');
        sendAjax("/groups/getReunion",
                {id_reunion:id_reunion},
                "#loading-reunion",
                function(data){
                    reunion_list=
                        "<strong>"+data.title+"</strong><br /><br />"+
                        "Grupo: <a href='/groups/"+data.group_slug+"'>"+data.group+"</a><br>"+
                        "Fecha de creaci&oacute;n: <strong>"+data.date_reunion+"</strong><br><br>"+
                        "<strong>"+data.convener+"</strong> convoc&oacute; a una reuni&oacute;n de "+
                        "<strong>"+data.group+"</strong> para el d&iacute;a "+
                        "<strong>"+data.date_convened+"</strong> en <strong>"+data.locale+"</strong> <br /><br />"+
                        "Los objetivos propuestos son: <br /> <strong>"+data.agenda+"</strong><br />"+
                        "Lista de asistentes: <table class='tabla'><tr><th>INTEGRANTE</th><th>RESPUESTA</th></tr>";
                        $.each(data.assistants,function(){
                            reunion_list = reunion_list+
                        "<tr><td><img class='img20' src='"+this.gravatar+"''> <strong>"+this.username+"</strong></td><td>"+this.is_confirmed+"</td></tr>"});
                        reunion_list = reunion_list +"</table> <br /> ";
                        if (data.is_done == false)
                            reunion_list = reunion_list + "Esta reuni&oacute;n a&uacute;n no ha sido realizada";
                        else
                            reunion_list = reunion_list + "Esta reuni&oacute;n ya ha sido realizada";
                        if (data.iconf == 1)
                            reunion_list = reunion_list + "<br /><br /><a href='/groups/"+data.group_slug+"/newMinutes"+id_reunion+"' class='btn btn-success' >Crear Acta</a>";
                        
                    //console.log(reunion_list)
                    $('#reunion-data').html(reunion_list);
                }
        );
    }


    setButtons();
</script>
{% endif %}
{% endblock %}
{% extends "website/layout.html" %}
{% block TITLE %}Actarium - home{% endblock %}

{%block body%}
<article>
    <header class="row-fluid">
        <h1 class="span10">Actarium</h1>
        <div class="fix_btn"><a href="#myModal" role="button" class="btn" data-toggle="modal">Feed-back <i class="icon-bullhorn"></i></a></div>
        
    </header>

    {% if user.is_authenticated %}
    <hr>
    <div class="row-fluid">
        <section class="span6">
            <header>
                <h4>Actividad Reciente  
                {% if user.is_staff %}
                	<a href="/actions" role="button" class="btn" style="float:right">Acciones</a>
                {% endif %} 
                </h4>
            </header>
            <div class="accordion " id="accordion">
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#Invitations">
                            Tienes <span id="inv-count" class="badge badge-info">{{invitations|length}}</span> invitaciones a grupos
                        </a>
                    </div>
                    <div  id="Invitations" class="accordion-body collapse in">
                        <ul class="accordion-inner">
                            {% for invitation in invitations %}
                            <li>
                                <span class="notification-text alpha60">
                                    <strong>{{invitation.id_user_from.first_name|lower|capfirst}}</strong> te invit&oacute; al grupo <a href="/groups/{{invitation.id_group.slug}}">{{invitation.id_group.name|lower|capfirst}}</a>
                                    <br />
                                    <time datetime="{{reunion.date_convened|date:'c'}}">El {{invitation.date_invited}}</time>
                                </span>
                                <div class="buttons">
                                    <button type="button" data-invitation="s{{invitation.id}}" class="accept-inv btn btn-small btn-info">
                                        Aceptar 
                                         <span class="load"></span>
                                    </button>
                                    <button type="button" data-invitation="n{{invitation.id}}" class="accept-inv btn btn-small">
                                        Cancelar
                                         <span class="load"></span>
                                    </button>
                                    <div class="pull-right load"></div>
                                </div>
                                <hr>

                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#Reunions">
                            Tienes <span id="length-reunion" class="badge badge-info">{{reunions|length}}</span> reuniones pendientes
                        </a>
                    </div>
                    <div  id="Reunions" class="accordion-body collapse in">
                        <ul class="accordion-inner">
                            
                            {% for reunion in reunions %}
                        
                            <li data-group_name="{{reunion.group_name}}" data-date="{{reunion.date}}">
                                <span class="notification-text">
                                    <strong>Grupo </strong><a href="/groups/">{{reunion.group_name}}</a><br />
                                    <time datetime="{{reunion.date}}">El {{reunion.date}}</time>
                                </span>
                                <div class="buttons">
                                    <a href="#" class="btn btn-small btn-info confirmed2-true" data-id_reunion="{{reunion.id_reunion}}">Asistir&eacute;</a>
                                    <a href="#" class="btn btn-small confirmed2-false" data-id_reunion="{{reunion.id_reunion}}">No Asistir&eacute;</a>
                                    <a class="btn btn-link" href="#">Ver m&aacute;s</a>
                                </div>
                                <hr>

                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div><!--cierra notifications-->
        </section>
        <section class="span5 margint30">
            <header class="row-fluid fix_btn">
                <h4 class="span7">Tus grupos</h4>

                <div class="span4">
                    <a href="/groups/new" class="btn btn-small">
                        <i class="icon-book"></i> Crear Grupo
                    </a>
                </div>
            </header>
            <hr>
            <ul id="group-list" class="nav onOver">
                {% for group in groups %}
                <li class="img-rounded">
                    <a href="/groups/{{group.slug}}">
                        <img src="{{ STATIC_PREFIX }}{{group.img_group}}" alt="{{group.name}}"/>
                        {{group.name}}
                    </a>
                </li>
                {% endfor %}
            </ul>

        </section>
    </div>
    {% else %}
    <div class="containterMargin">
        <p>La soluci&oacute;n empresarial para el registro y seguimiento de sus reuniones.</p>
        <div class="sing">
            <a href="/account/new" class="btn btn-info btn-large">Registrarse</a>
            <a href="/account/login" class="btn btn-info btn-large">Ingresar</a>

        </div>
    </div>
    {% endif %}



    <div class="modal hide fade" id="myModal">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Env&iacute;anos tus comentarios</h3>
        </div>
        <div class="modal-body">
            <p>Cu&eacute;ntanos c&oacute;mo fue tu experiencia usando Actarium y ay&uacute;danos a mejorar.</p>
            <textarea id="textComent" placeholder="Ejemplo: No puedo cerrar sesi&oacute;n en dispositivos m&oacute;viles"></textarea>
        </div>
        <div class="modal-footer">
            <div id="twitter-button">
                <a href="https://twitter.com/intent/tweet?screen_name=Actarium" class="twitter-mention-button" data-lang="es" data-size="large" data-related="Actarium">Tweet to @Actarium</a>
            </div>
            <a href="" class="btn" data-dismiss="modal" aria-hidden="true">Cancelar</a>
            <a href="" class="btn btn-primary">Enviar</a>
        </div>
    </div>


</article>
{%endblock%}
{% block style%}
<style>
    #twitter-button{
        height: 30px;
        width: 177px;
        display: inline-block;
        float: left;
    }
    #textComent{
        margin-left: 12%;
        margin-right: 12%;
        min-height: 150px;
        width: 70%;
    }
    .accordion-heading{
        /*background-image: -webkit-linear-gradient(top, #62C462, #51A351);*/

        background-image: -webkit-linear-gradient(top, white, #E6E6E6);
        border-radius:5px;
    }

    .accordion-inner{
        /*background-color: gainsboro;*/
        /* Fallback for web browsers that doesn't support RGBa */
        background: rgb(255, 255, 255) transparent;
        /* RGBa with 0.6 opacity */
        background: rgba(255, 255, 255, 0.6);
        /* For IE 8*/
        -ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorstr=#11111111,endColorstr=#11111111)";
    }
    .span6 h4{
        margin-bottom:20px;
    }
    span.notification-text{
        display: block;
    }
    h4{
        margin:0;
        padding:0;
    }
    header h1{
        margin: 0;
    }
    .span2{
        margin-right: 20px;
    }
    .span6{
        border-right: solid thin #dadada;
        padding: 0 20px;
    }
    section div ul li{
        list-style-type: none;
        font-size: 12px;
        margin-bottom: 5px;
    }
    li hr{
        margin:20;
    }
    ul{
        margin:0;
    }
    .containterMargin{
        margin:20px;
    }
    .buttons{
        margin-top:10px;
    }
</style>
{%endblock%}
{% block js %}
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<script>
    
    $(".collapse").collapse({
        //toggle: false
    })
    function acceptInvitation(element, accept){
        sendAjax(
        "/groups/acceptInvitation",
        {"i_id":accept},
        $(element).find(".load"),
        function(data){
            if (data["accepted"]){
                var actual = parseInt($("#inv-count").text());
                actual--;
                $("#inv-count").text(""+actual);
                $("#group-list").append(
                "<li class='img-rounded'>"+
                    "<a href='"+data["group"]["slug"]+"'>"+
                    "<img src='{{STATIC_PREFIX}}"+data["group"]["img_group"]+"' alt=''/>"+
                    data["group"]["name"]+
                    "</a>"+
                    "</li>")
                $(element).parent().parent().slideUp(900,function(){
                    $(this).empty().html(
                    "Ahora perteneces al grupo "+
                        "<a href='"+data["group"]["slug"]+"'>"+data["group"]["name"]+"</a>"+
                        "<hr>"
                ).fadeIn()
                }
            )
                setAlertMessage("Invitaci&oacute;n a un nuevo grupo",
                "Ahora puedes acceder al grupo"+data["group"]["name"]+".")
            }
            else{
                $(element).parent().parent().slideUp(900,function(){
                    $(this).empty().html(
                    "Cancelaste la invitaci&oacute;n para unirte al grupo "+data["group"]["name"]+"."+
                        "<br>"+
                        "Si lo hiciste por error comunicate con el administrador del grupo para "+
                        "obtener una nueva invitaci&oacute;n."+
                        "<hr>"
                ).fadeIn()
                })
                var actual2 = parseInt($("#inv-count").text())
                actual2--
                $("#inv-count").text(""+actual2)
                setAlertMessage("Invitaci&oacute;n a un nuevo grupo",
                "Haz rechazado la invitaci&oacute;n")
            }
        })
    }
    $(".accept-inv").on("click",function(e){
        e.preventDefault();
        $(this).attr("disabled", "disabled");
        var accept = $(this).attr("data-invitation")
        if(accept.substring(0,1)=="n"){
            if(confirm("¿Seguro que no quieres ser parte de este grupo?")){
                acceptInvitation($(this), accept)
            }
            else{
                $(this).attr("disabled", false);
            }
        }else{
            acceptInvitation($(this), accept)
        }
    })
    function confirmar(id_reunion, is_confirmed, group_name, date){
		sendAjax("/groups/setAssistance",
    			{id_reunion:id_reunion, is_confirmed: is_confirmed},
    			"#load_reunions",
    			function(data){
                    console.log(data)
                    setAlertMessage("Reuniones", "Puedes ver la actividad de tus reuniones en el men&uacute; <a href='/groups/calendar'>Reuniones</a>")
    			}
    	)
	}
    function setList(e,btn, op){
		var t = 500;
		e.preventDefault();
		li= btn.parent().parent();
		li.animate({'height': 0},t,function(){
			confirmar(btn.attr("data-id_reunion"),op, $(this).attr("data-group_name"), $(this).attr("data-date"));
			$(this).remove();
			l = $("#length-reunion").html();
			$("#length-reunion").html(l-1);
		});
	}
    function setButtons(){
		$('.confirmed2-true').click(function(e){
            $(this).attr("disabled", "disabled");
			setList(e,$(this), true);
		});
		$('.confirmed2-false').click(function(e){
            $(this).attr("disabled", "disabled");
			setList(e,$(this),false);
		});	
	}
	setButtons();
    
</script>
{% endblock %}
{% extends "groups/menu.html" %}
{% block TITLE %}Acta {{minutes.code}} Grupo {{minutes.id_group.name}} {% endblock %}
{% load gravatartag %}
{% load i18n %}

{% block toolbar_content %}
<ul class="list-unstyled">
	<li>
		<a href="{%if not rel_user.is_secretary%}#{%else%}/groups/{{group.slug}}/roles-for-this-minutes{%endif%}" class="title-on-disabled {%if not rel_user.is_secretary%}disabled{%endif%}" {%if not rel_user.is_secretary%}title="{% trans 'Necesitas ser redactor para habilitar esta opci&oacute;n' %}"{%endif%}>
	            <span class="glyphicon glyphicon-plus"></span> {% trans "Crear acta" %}
	        </a>
	</li>
   <!--  <li>
        <a href="{%if not rel_user.is_secretary%}#{%else%}/groups/{{group.slug}}/uploadMinutes{%endif%}" class="title-on-disabled {%if not rel_user.is_secretary%}disabled{%endif%}" {%if not rel_user.is_secretary%}title='{% trans "Necesitas ser redactor para habilitar esta opci&oacute;n" %}'{%endif%}>
            <i class="glyphico glyphicon glyphicon-cloud-upload"></i> {% trans "Subir acta" %}
        </a>
    </li> -->
	{% if is_secretary and not minutes.is_full_signed%}
    <li>
		<a href="#" class="" id="minutes-edit"><i class="glyphicon glyphicon-pencil"></i> Editar</a>
    </li>
	{%endif%}
	{%if minutes_version%}
    <li>
		<a href="#" id="history" class="">Veriones ({{minutes_version|length}})</a>
    </li>
	{%endif%}
    <li>
    	<form id="pdf-form" method="post" class="">
			{% csrf_token %}
			<input type='hidden' id="minutes-html-data" name="minutes-html-data" value="">
			<a href="#" id="btn-generate-pdf" class="{%if not minutes.is_full_signed%}disabled{%endif%}" {%if not minutes.is_full_signed%}title="Los PDF solo son generados para actas aprobadas."{%endif%}><i class="glyphicon glyphicon-file"></i> PDF</a>
		</form>
    </li>
    <li class=" important">
		<a class="{%if not next %}disabled{%endif%}" href="{%if next %}{% url 'show_minute' group.slug next.code %}{%else%}#{%endif%}"><i class="glyphicon glyphicon-arrow-right"></i></a>
    </li>
    <li class=" important">
		<a class="{%if not prev %}disabled{%endif%}" href="{%if prev %}{% url 'show_minute' group.slug prev.code %}{%else%}#{%endif%}"><span class="glyphicon glyphicon-arrow-left"></span></a>
    </li>
</ul>
{% endblock %}

{%block menu_content%}
	{% if space_to_approve or is_secretary %}
		{% if my_attending%}
		<div id="message-temp" class="white-box-container">
			<header>
				<div id="first-point"></div>
				<div class="pull-left ico-title"><img src="{{ STATIC_PREFIX }}img/groups/default.jpg"> </div> 
				<h4> {{user.first_name}} &eacute;sta Acta necesita tu aprobaci&oacute;n</h4>
				<p>
					<small>&Eacute;sta Acta no ser&aacute; publicada a todo el grupo {{group.name}} hasta que los miembros asignados como comisi&oacute;n aprobatoria est&eacute;n de acuerdo con su redacci&oacute;n.</small>
				</p>
			</header>
			<hr>
			<div id="approve-message-up" class="div-sign alert ">
	    		<strong>Tu voto: </strong> Apruebas &eacute;sta Acta?
		    	<a href="#approve" class="btn btn-info btn-approve" data-minutes="{{minutes.id}}" data-approve="1">
					<i class="glyphicon glyphicon-ok icon-white"></i> Si, apruebo <span></span>
				</a>
				<a href="#new-annotation"  class="btn btn-no-approve" data-minutes="{{minutes.id}}" data-approve="0">
					<i class="glyphicon glyphicon-comment"></i> No, Necesita correcci&oacute;n <span></span>
				</a>
			</div>
			<div class="mt20">
				<strong class="mt20">Comisi&oacute;n aprobatoria:</strong>
				<ol class="commission-approving-list" class="mt20">
					{%for member in commission_approving%}
						<li class="missing-{{member.id_user.id}}">
							<div>
								<img style="width:20px" src="{{member.id_user.email|showgravatar:'20'}}">
							</div>
							<div>
							{{member.id_user.first_name}} {{member.id_user.last_name}}
							</div>
							<div class="icon-approver-status">
								{%ifequal member.is_signed_approved 0%}
								<i class="glyphicon glyphicon-time"></i>
								{%endifequal%}
								{%ifequal member.is_signed_approved 1%}
								<i class="glyphicon glyphicon-ok"></i>
								{%endifequal%}
								{%ifequal member.is_signed_approved 2%}
								<i class="icon-remove-circle"></i>
								{%endifequal%}
							</div>
						</li>
					{%endfor%}
				</ol>
			</div>
		</div>
		{% endif %}
	{% endif %}
	<article>
	    <div id="minutes-version" style="background-color:rgb(245,245,245);display:none">
	    	<p>Historial de versiones:</p>
	    	{%for minutes in minutes_version%}
	    		{{minutes.full_html|safe}}
	    		<hr>
	    	{%endfor%}
	    </div><!-- 
	    			<div class="alert">
					  <strong>Ayúdenos a mejorar!</strong><br>Por favor responda esta pequeña encuesta, le tomará sólo un minuto.
					  <a href="#encuesta" role="button" class="btn btn-info btn-large" data-toggle="modal">Responder encuesta</a>
					</div> -->
	    <div id="minutes-container">
	    {{minute_template}}
	    </div>

		{% include "groups/siteToApprove.html" %}
	</article>
	<span id="is_form" style="display:none">{{is_form}}</span>

{%endblock%}
{% block menu_content_js %}
<script src="{{STATIC_PREFIX}}js/vendor/tiny_mce/tiny_mce.js"></script>
<script src="{{STATIC_PREFIX}}js/vendor/waypoints.min.js"></script>
<script>
	$(document).on("ready",function(){
		$("#group-menu-folder").addClass("active");
		$("#btn-generate-pdf").on("click", function (e) {
			e.preventDefault();
			e.preventDefault();
			{%if minutes.is_full_signed%}
			$("#pdf-form").submit();
			{%endif%}
		}).tooltip();
		$('#first-point').waypoint(function() {
			if($("#approve-message-up").hasClass("minutes-bar-static")){
				$("#approve-message-up").removeClass("minutes-bar-static").css({"position": "relative"});
			}
			else{
				$("#approve-message-up").addClass("minutes-bar-static").css({"position": "fixed"});
			}
		});
		$(".btn-approve").on("click", setApprove);
		$(".btn-no-approve").on("click", newAnnotation);
		$("#button-save").on("click", saveAnnotation);
		$('#minutes-html-data').val($('#minutes').html());

		$("#history").on("click", function (e) {
			e.preventDefault();
			$("#minutes-version").slideToggle();
		})

		{% if is_secretary %}
		$("#minutes-edit").on("click", function (e) {
			if(confirm("Seguro que desea editar esta Acta?")){
				top.location = "{% url 'edit_minutes' group.slug minutes.code minutes.id_template.slug %}"
			}
		})
		{% endif %}
		if(window.location.hash){
			console.log(window.location.hash);
			$(window.location.hash+" > div").addClass("selected-annontation");
		}
	});
	function callBackApprove(data){
		console.log(data.signs)
		$(".div-sign").fadeOut(300,function(){$(this).empty();$("#message-temp").hide(300, function () {
			$(this).empty();
		})});
		var u = $(".missing-"+data["user-id"]);
		if(data['approved']==1){
			u.find("div.icon-approver-status").html('<i class="glyphicon glyphicon-ok"></i>');
			setAlertMessage("Aprobado!", "Haz aprobado esta acta.");
		}
	}
	function setApprove(e){
		e.preventDefault();
		$(this).attr({"disabled":"disabled"});
		var minutes_id = $(this).attr("data-minutes");
		var is_approved = parseInt($(this).attr("data-approve"));
		sendAjax(
			"/groups/setApprove",
			{"m_id":minutes_id, "approve": is_approved},
			"#btn-sign span",
			callBackApprove
		);
	}
	function goToByScroll(element, callback){// Scroll
	    $('html,body').animate({
	        scrollTop: $(element).offset().top - 100},
	        'slow', callback);
	}
	function newAnnotation(e){
		e.preventDefault(e);
		tinyMCE.init({
	        theme : "simple",
	        mode : "textareas",
	        height : "80",
	        width : "100%",
	        content_css : "{{STATIC_PREFIX}}js/vendor/tiny_mce/themes/simple/skins/default/editorstyles.css",
		});
		$("#new-annotation").removeClass("hidden");
		goToByScroll("#new-annotation", function(){
			$("#new-annotation textarea").focus();
			tinyMCE.get('textarea-new-annotation').focus();
		}
		);
	}
	function saveAnnotation(e){
		var t = tinymce.get('textarea-new-annotation').getContent();
		var username = "{{user.first_name}} {{user.last_name}}";
		var gravatar = "{{ user.email|showgravatar:'32'}}";
		/*
		USAR TEMPLATES: MUSTACHE
		*/
		var params = {"annotation": t, "minutes_id": {{minutes.id}}}
		sendAjax("/groups/{{group.slug}}/add-new-annotation",params,"", function(data){
			if(data){
				// console.log(data)
				var m = '<div class="annotation bb">\
								<div class="user-gravatar pull-left">\
									<img class="size32 avatar" src="' + gravatar + '" alt="' + username + '" />\
								</div>\
								<div class="name-user-annotation">\
									<strong>' + username + '</strong>\
									· <time>Ahora mismo</time>\
								</div>\
								<div class="content-annotation">'+
									t +
								'</div>\
						</div>';
				$("#annotations").prepend("<li>" + m + "</li>");
				tinymce.get('textarea-new-annotation').setContent("");
			}
			else{
				setAlertError("Error", "Algo ocurri&oacute;");
			}
		});
	}
</script>
{% include minutesTemplateJs %}
{% endblock %}

{% block menu_content_style%}
<style>
	.selected-annontation{background-color: rgb(240, 240, 240);;}
	.content-annotation{margin-left: 40px}
	.comment-annotation p{font-size: 14px;}
	.name-user-annotation{margin-left: 40px}
	.name-user-annotation time{font-size: 14px;color: gray}
	.annotation{padding: 10px;}
	ul#annotations > li > div{margin-top: 25px;}
	#button-save{margin-top: 5px;}
	article header img{margin-top: 0px;}
	#annotations-approve{margin-top: 20px;}
	.commission-approving-list > li > div{display: inline;}
	.icon-approver-status i{margin-top: 5px}
	#body-container > article{margin-top:0;padding-top: 0;}
	#minutes-bar{background-color: rgb(251, 251, 251); padding: 5px 0;position: absolute;left: 0;width:100%;margin-top: 0px;}
	#minutes-bar-hoja{width: 75%;}
	.header-minutes{background-color: rgb(251, 251, 251); padding: 15px 0;position: absolute;left: 0;width: 100%;margin: 0;}
	.header-minutes > div{margin: 0 auto;margin-bottom: 8px;width: 90%;}
	.minutes-bar-static{position: fixed;top: 73px;width: 50%;left: 0;right: 0;margin: 0 auto;}
	#minutes-container > section{margin-top: 0px;padding-top: 0 !important}
	#minutes{padding-right: 0;padding-left: 0;}
	#toolbar-btn > ul > li > form{margin: 0}
	.ico-title{margin-top: -4px;margin-right: 2px;}
	.important{z-index: 2001}

	@media (max-width: 979px) {
		.minutes-bar-static{top: 0px;}
	}
</style>
{% endblock %}
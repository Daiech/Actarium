{% extends "website/layout.html" %}
{% block TITLE %}Actarium - Actas{% endblock %}

{%block body%}
<article>
    <h2>Pr&oacute;ximas reuniones  </h2>
    <hr>
    <section id="calendar" >
        <div id="datepicker">
            <img src="/static/img/load16.gif" alt="cargando calendario"/>
        </div>
        <div class="modal hide fade" id="myReunionModal">
			<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3>Reunion</h3>
			</div>
			<div class="modal-body">
				<div id="reunion-data">
					<div id="loading-reunion"></div>
	        	</div>
			</div>
		</div>
		<div class="modal hide fade" id="newReunionModal">
			<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3>Convocar nueva reunion</h3>
			<hr>
			<h4>Elige un grupo</h4>
			</div>
			<div class="modal-body">
				<select id="select-group">
					<option value="0">Selecciona un grupo</option>
				</select>
			</div>
		</div>
        <div class="center">
            <a href="/groups/calendar" class="btn btn-success ">Ver todas las reuniones</a><br><br>
            <a href="#newReunionModal" data-toggle="modal" class="btn btn-success ">Convocar reunion</a>
        </div>
    </section>
    <section id="date_reunions"></section>
    <section id="reunions" >
    	<div id="load_reunions"></div>
    </section>
</article>
{%endblock%}
{%block style%}
<style>
    h2{
        margin-left: 20px;
    }
    h3{
        margin-bottom: 20px;
    }
    .form-horizontal table{
        margin: auto;
        width: auto;
    }

    table td .btn{
        margin-top:10px;
    }
    #calendar {
        padding-left: 30px;
        padding-top: 10px;
        float:left;
    }
    #date_reunions{
    	 padding-left: 40px;
    	 float: left;
    }
    #reunions {
        width: 490px;
        margin-left: 40px;
        float:left;
    }
    #reunions > ul li{
        font-size: 14px;
        list-style: none;
    }
    #reunions > ul{

        margin-left: 0;
    }
    .btn-link{
        padding-left: 0;
    }
    .botonera{
        display:block;
        margin-top:10px;
    }
    .center{
        margin: 10px auto;
        width: 180px;
    }
    #bold_date{
    	font-size:21px;
    }
    .tabla {
		font-size: 12px;
		background-color: #fdfdf1;
		color: #990000;
		text-align:left;
	}
	.tabla td {
		padding: 5px;
		border-bottom-width: 1px;
		border-bottom-style: solid;
		border-bottom-color: #EBE9BC;
	}

</style>
<link rel="stylesheet" media="all" type="text/css" href="{{ STATIC_PREFIX }}css/jquery-ui-1.9.1.custom.css" />
{%endblock%}

{% block js %}
<script src="{{ STATIC_PREFIX }}js/vendor/jquery-ui.min.js"></script>
<script>$("#menu-reunions").addClass("active")</script>
<script type="text/javascript" ><!--
$(document).on("ready", function() {
	
	var events = [
		{% for reunion in reunions %}
			"{{reunion.date_reunion|date:'Y-m-d'}}",
		{% endfor %}                            
	];
	$( "#datepicker" ).text("")
    var dp = $( "#datepicker" ).datepicker({ 
        monthNames: ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'],
    	dayNamesMin: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
    	nextText: 'Siguiente',
    	prevText: 'Anterior',
    	dateFormat: 'yy-mm-dd',
    	beforeShowDay: function(date) {
	    	var current = $.datepicker.formatDate('yy-mm-dd', date);
	    	return jQuery.inArray(current, events) == -1 ? [true, 'ui-state-disabled'] : [true, 'encima', 'aqui hay un evento!'];
    	},
	    onSelect: function(dateText, inst) {  
	    	sendAjax("/groups/getReunions",
	    			{date:dateText},
	    			"#load_reunions",
	    			function(data){
		    			//console.log(data);
		    			url = location.pathname;
		    			url2 = "/groups/calendar";
		    			if (url == url2){
			    			html5url = "calendar/"+dateText;
		    			}
		    			else{     
			    			html5url = dateText;
		    			}
		    			window.history.pushState(data, dateText, html5url);
		    			show_data(data)
		    			$("#date_reunions").html("<h4>Reuniones para la fecha:  <span id='bold_date'>"+dateText+" </span> </h4>");
		    			setconfirmButton();
		    			setRejectButton();
		    			setButtons();
		    			
	    		}
	    	)
    	}
	});
    url = location.pathname;
	url2 = "/groups/calendar";
	if (url != url2){
		dp.datepicker("setDate", (url).substring(17,27));  
		$("#date_reunions").html("<h4>Reuniones para la fecha:  <span id='bold_date'>"+(url).substring(17,27)+" </span> </h4>");
	}
	
	function show_data(data){
		var full_text = "";
		var list1="<h3 id='confirmadas2'>Reuniones confirmadas</h3><ul id='confirmadas'>";
		var list2="<h3 id='pendientes2'>Reuniones pendietes por confirmar</h3><ul id='pendientes'>";
		var list3="<h3 id='rechazadas2'>Reuniones rechazadas</h3><ul id='rechazadas'>";
		var o1 = 0;
		var o2 = 0;
		var o3 = 0;
		$.each(data, function() { 
			//console.log(data);
			if(this.is_saved == 1){
				if(this.is_confirmed == 'True' || this.is_confirmed == true){ //reuniones confirmadas
					if (o1== 0){ o1 = 1 };
					list1 = list1 + createList(1,this.group_name,this.group_slug,this.date,this.id_r);
				}
				else { //reuniones rechazadas
					if (o3== 0){ o3 = 1 };
					list3 = list3  + createList(2,this.group_name,this.group_slug,this.date,this.id_r);
				}
			}
			else{ //reuniones pendientes por confirmar
				if (o2== 0){ o2 = 1 };
				list2 = list2 + createList(3,this.group_name,this.group_slug,this.date,this.id_r);
			}
		});
		list1 =list1+"</ul>";
	    list2 =list2+"</ul>";
	    list3 =list3+"</ul>";
	    
	    if (o1 == 1)
		    full_text = full_text + list1;
	    if (o2 == 1)
	    	full_text = full_text + list2;
	    if (o3 == 1)
	    	full_text = full_text + list3;
		$("#reunions").html(full_text);
		setMoreButton();
	}
	
	var x = '{{ my_reu_day_json|safe }}';
	if (x!=''){
		show_data(JSON.parse(x));}
	
	function confirm(id_reunion, is_confirmed, group_name,group_slug, date){
		//console.log(id_reunion+" "+is_confirmed);
		sendAjax("/groups/setAssistance",
    			{id_reunion:id_reunion, is_confirmed: is_confirmed},
    			"#load_reunions",
    			function(data){
    				var list1="<h3 id='confirmadas2'>Reuniones cofirmadas</h3><ul id='confirmadas'></ul>";
					var list2="<h3 id='rechazadas2'>Reuniones rechazadas</h3><ul id='rechazadas'></ul>";
    				if(is_confirmed == true){
    					//console.log($('#confirmadas').html());
        				L = createList(1,group_name,group_slug,date,id_reunion);
        				if($('#confirmadas').length){
        					//console.log('si existe');
        					list= $('#confirmadas').html();
        					//console.log(list);
        					//console.log(L);
        					$('#confirmadas').html(list+L);
        				}
    					else{
        					//console.log('no existe');
        					$('#reunions').prepend(list1);
        					$('#confirmadas').html(L);
    					}
        				setRejectButton();
    				}
        			else{
            			L = createList(2,group_name,group_slug, date,id_reunion);
            			if($('#rechazadas').length){
        					//console.log('si existe');
        					list= $('#rechazadas').html();
        					//console.log(list);
        					//console.log(L);
        					$('#rechazadas').html(list+L);
        				}
    					else{
        					//console.log('no existe');
        					$('#reunions').append(list2);
        					$('#rechazadas').html(L);
    					}
            			setconfirmButton();
        			}
    				setMoreButton();			
    			}
    	)
	}
	function getReunionData(id_reunion){
		//console.log('dame una reunion');
		sendAjax("/groups/getReunion",
    			{id_reunion:id_reunion},
    			"#loading-reunion",
    			function(data){
    				reunion_list=
						"Reunion convocada el <strong>"+data.date_reunion+"</strong> por <strong>"+data.convener+"</strong>  en el grupo <strong>"+data.group+"</strong>  <br /> Se llevara a cabo el <strong>"+data.date_convened+"</strong> <br /><br /> Objetivos: <br /> <strong>"+data.agenda+"</strong><br />Asistentes: <br /><table class='tabla'>";
						$.each(data.assistants,function(){reunion_list = reunion_list+ "<tr><td><strong>"+ this.username+ "</strong></td><td>"+this.is_confirmed+"</td></tr>"});
						reunion_list = reunion_list +"</table> <br /> ";
    	    			if (data.is_done == false)
    	    				reunion_list = reunion_list + "Esta reunion aun no ha sido realizada";
    	    			else
    	    				reunion_list = reunion_list + "Esta reunion ya ha sido realizada";
   	    				if (data.iconf == 1)
       	    				reunion_list = reunion_list + "<br /><br /><a href='/groups/"+data.group_slug+"/newMinutes"+id_reunion+"' class='btn btn-success' >Crear Acta</a>";
    	    			
				    //console.log(reunion_list)
					$('#reunion-data').html(reunion_list);
    				//setMoreButton();
    			}
    	);
	}
	function setconfirmButton(){
		$('.confirmed-true').click(function(e){
			setList(e,$(this),$('#rechazadas'),$('#rechazadas2'), true);
		});
		
	}
	function setRejectButton(){
		$('.confirmed-false').click(function(e){
			setList(e,$(this),$('#confirmadas'),$('#confirmadas2'), false);
		});	
	}
	
	function setButtons(){
		$('.confirmed2-true').click(function(e){
			setList(e,$(this),$('#pendientes'),$('#pendientes2'), true);
		});
		$('.confirmed2-false').click(function(e){
			setList(e,$(this),$('#pendientes'),$('#pendientes2'),false);
		});	
	}
	function setMoreButton(){
		$('.get-reunion').click(function(e){
			e.preventDefault();
			getReunionData($(this).attr("data-id-reunion"));
		});
	}
	setconfirmButton();
	setRejectButton();
	setButtons();

	function setList(e,btn, ul, h3, op){
		var t = 500;
		e.preventDefault();
		li= btn.parent().parent();
		li.animate({'height': 0},t,function(){
			confirm(btn.attr("data-id_reunion"),op, $(this).attr("data-group_name"), $(this).attr("data-date"));
			$(this).remove()
			console.log("|"+ul.text()+"|");
			if(ul.text()==""){ul.remove(); h3.remove()}
		});
	}

	function createList(type,group_name,group_slug,date,id_reunion){
		li='<li id="reunion_'+id_reunion+'" data-group_name="'+group_name+'" data-date="'+date+'">'+
				'<span class=""> '+
		    		' Grupo <a href="/groups/'+group_slug+'">'+group_name+'</a> Hora: '+date+
		    	'</span>'+
		    	'<div class="botonera">';
				    switch (type){
					    case 1 : {
				 			li = li + '<a href="#" class="btn btn-small btn-info confirmed-false" data-id_reunion="'+id_reunion+'">Cancelar</a>';
				    	}; break;
					    case 2 : {
							li = li + '<a href="#" class="btn btn-small btn-info confirmed-true" data-id_reunion="'+id_reunion+'">Asistir&eacute;</a>';
				    	}; break;
					    case 3 : {
							li = li + ' <a href="#" class="btn btn-small btn-info confirmed2-true" data-id_reunion="'+id_reunion+'">Asistir&eacute;</a> '+
							    	  ' <a href="#" class="btn btn-small confirmed2-false" data-id_reunion="'+id_reunion+'">No Asistir&eacute;</a> ';
						}; break;
				    }
					li = li+' <a class="btn btn-link get-reunion" href="#myReunionModal" data-toggle="modal" data-id-reunion="'+id_reunion+'">Ver m&aacute;s</a> '+
		    	'</div>'+
		    	'<hr>'+
			'</li>';
		return li;
	}
	function getUrlVars() {
	    var vars = {};
	    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
	        vars[key] = value;
	    });
	    return vars;
	}
		
	function chargeWindow(){
		{% for group in groups %}
				$('#select-group').append('<option value="{{ group.slug }}" >{{ group.name }}</option>');
		{% endfor %}
		$('#select-group').change(function(){
			group_slug = $('#select-group option:selected').val()
			if (group_slug != "0"){
				window.location = "/groups/newReunion/"+group_slug;}
		});
		if( getUrlVars()["r"]){
			$('#reunion_'+getUrlVars()["r"]).css('background-color',"#51a351");
			$('#reunion_'+getUrlVars()["r"]).animate({'background-color': '#eeeeee'},3500,function(){ });
		}
	}
	//setAlertMessage('Titulo', 'Contenido');
	chargeWindow();


	
});
</script>
{% endblock %}